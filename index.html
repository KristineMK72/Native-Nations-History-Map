<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>üåç Echoes of the Land: Global Indigenous Story Map</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<style>
html, body {
    height: 100%;
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background-color: #111;
    color: #eee;
    overflow: hidden;
}
header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    padding: 10px 0;
    background: rgba(0, 0, 0, 0.9);
    color: #fff;
    text-align: center;
    z-index: 2000;
    height: 50px;
}
header h1 { margin: 0; font-size: 1.5em; color: #800080; }
header p { margin: 0; font-size: 0.9em; color: #ccc; }

#main-app {
    position: absolute;
    top: 50px;
    width: 100%;
    height: calc(100vh - 50px);
    display: flex;
}
#storyPanel {
    width: 30%;
    min-width: 280px;
    background: rgba(20, 20, 20, 0.9);
    padding: 1.5em;
    overflow-y: auto;
    z-index: 10;
    box-sizing: border-box;
    transition: transform 0.3s ease-in-out;
}
#map {
    flex-grow: 1;
    height: 100%;
    z-index: 1;
}
#map-title-overlay {
    position: absolute;
    top: 50px;
    left: 30%;
    width: 70%;
    background: rgba(0, 0, 0, 0.6);
    color: #fff;
    z-index: 10;
    text-align: center;
    line-height: 40px;
    font-size: 1.1rem;
    font-weight: bold;
    border-bottom: 2px solid #800080;
}
.controls {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    display: flex;
    justify-content: center;
    background: #222;
    padding: 8px;
    gap: 8px;
    z-index: 10000;
}
.controls button {
    background: #444;
    color: #eee;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
}
.story-marker div {
    background-color: #800080;
    color: #FFD700;
    font-size: 16px;
    font-weight: bold;
    text-align: center;
    border-radius: 50%;
    width: 26px;
    height: 26px;
    line-height: 26px;
    border: 2px solid #FFD700;
    transition: all 0.3s ease-in-out;
    box-shadow: 0 0 8px rgba(128, 0, 128, 0.8);
}
@media (max-width: 768px) {
    #main-app { flex-direction: column; }
    #storyPanel {
        width: 100%;
        height: 100%;
        transform: translateY(100%);
        position: absolute;
    }
    #storyPanel.visible { transform: translateY(0); }
    #map-title-overlay { display: none; }
}
</style>
</head>
<body>
<header>
    <h1>üåø Echoes of the Land</h1>
    <p>A Story Map of Indigenous Peoples' Journeys</p>
</header>

<div id="map-title-overlay">Earliest North American Migrations</div>

<audio id="powWowAudio" loop preload="auto">
    <source src="audio/powwow_drum.mp3" type="audio/mpeg">
</audio>

<div id="main-app">
    <div id="storyPanel">
        <h2 id="storyEra"></h2>
        <p id="storyYear"></p>
        <p id="storyText"></p>
    </div>
    <div id="map"></div>
</div>

<div class="controls">
    <button id="playPause">Play/Next</button>
    <button id="reservationToggle">Show Reservations</button>
    <button id="trailToggle">Show Trail/Route</button>
    <button id="tribalToggle">Hide All Tribes (574)</button>
    <button id="zoomMN">Zoom to MN</button>
    <button id="storyToggle">Show Story</button>
    <button id="resetMap">Reset Map</button>
</div>

<script>
const storyChapters = [
    { name: "Beringia Crossing", year: "~20,000 BCE", coords: [64.8, -165.0], text: "Ancestors migrate from Asia via land bridge.", mapTitle: "Earliest North American Migrations" },
    { name: "Mississippian Culture", year: "~1000 CE", coords: [38.6, -90.1], text: "Cahokia: ancient urban center near St. Louis.", mapTitle: "Ancient Urban Centers" },
    { name: "Ojibwe Migration Route", year: "~1400 CE", coords: [46.75, -85.5], text: "Anishinaabe migrated west along the Great Lakes.", mapTitle: "The Great Lakes Crossing" },
    { name: "Dakota Conflict 1862", year: "1862 CE", coords: [44.75, -94.5], text: "U.S.‚ÄìDakota War due to broken treaties.", mapTitle: "The U.S.‚ÄìDakota War of 1862" },
    { name: "Mille Lacs Band", year: "Present", coords: [46.1, -93.6], text: "Modern Tribal Sovereignty in Minnesota.", mapTitle: "Mille Lacs Band of Ojibwe" }
];
const trailOfTearsData = [
    { coords: [35.5, -83.3] }, { coords: [34.9, -85.0] },
    { coords: [35.4, -94.4] }, { coords: [35.9, -94.9] }
];
const mnReservationsGeoJSON = {
    "type": "FeatureCollection",
    "features": [
        { "type": "Feature", "properties": { "name": "Red Lake Nation" }, "geometry": { "type": "Polygon", "coordinates": [[[-95.3, 48.2], [-95.3, 47.8], [-94.8, 47.8], [-94.8, 48.2], [-95.3, 48.2]]] } }
    ]
};
const tribalLocations574 = Array.from({ length: 50 }, (_, i) => ({
    name: `Tribal Entity ${i + 1}`, coords: [35 + Math.random() * 10, -115 + Math.random() * 20]
}));

let map, storyMarkersLayer, reservationLayer, trailLayer, tribalDotsLayer;
let currentChapter = 0;

window.addEventListener('DOMContentLoaded', () => {
    map = L.map('map', { center: [39.8, -98.5], zoom: 4 });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap & CartoDB'
    }).addTo(map);

    storyMarkersLayer = L.layerGroup().addTo(map);
    reservationLayer = L.layerGroup();
    trailLayer = L.layerGroup();
    tribalDotsLayer = L.layerGroup();

    storyChapters.forEach(ch => {
        const icon = L.divIcon({ className: 'story-marker', html: '<div>‚òÖ</div>' });
        L.marker(ch.coords, { icon }).bindPopup(`<b>${ch.name}</b><br>${ch.text}`).addTo(storyMarkersLayer);
    });

    L.geoJSON(mnReservationsGeoJSON, { style: { color: '#800080', fillOpacity: 0.3 } }).addTo(reservationLayer);

    L.polyline(trailOfTearsData.map(p => p.coords), { color: '#8B0000', weight: 3, dashArray: '6,4' }).addTo(trailLayer);

    tribalLocations574.forEach(d => {
        L.circleMarker(d.coords, { radius: 3, color: '#33ff33', fillColor: '#33ff33', fillOpacity: 0.7 })
            .bindPopup(`<b>${d.name}</b>`).addTo(tribalDotsLayer);
    });
    tribalDotsLayer.addTo(map);

    updateStoryPanel(storyChapters[currentChapter]);
    map.invalidateSize();
});

function updateStoryPanel(ch) {
    document.getElementById('storyEra').textContent = ch.name;
    document.getElementById('storyYear').textContent = ch.year;
    document.getElementById('storyText').textContent = ch.text;
    document.getElementById('map-title-overlay').textContent = ch.mapTitle;
    map.flyTo(ch.coords, 6, { duration: 1.5 });
}

// --- Controls ---
document.getElementById('playPause').onclick = () => {
    currentChapter = (currentChapter + 1) % storyChapters.length;
    updateStoryPanel(storyChapters[currentChapter]);
};
document.getElementById('reservationToggle').onclick = e => {
    if (map.hasLayer(reservationLayer)) { map.removeLayer(reservationLayer); e.target.textContent = 'Show Reservations'; }
    else { map.addLayer(reservationLayer); e.target.textContent = 'Hide Reservations'; }
};
document.getElementById('trailToggle').onclick = e => {
    if (map.hasLayer(trailLayer)) { map.removeLayer(trailLayer); e.target.textContent = 'Show Trail/Route'; }
    else { map.addLayer(trailLayer); e.target.textContent = 'Hide Trail/Route'; }
};
document.getElementById('tribalToggle').onclick = e => {
    if (map.hasLayer(tribalDotsLayer)) { map.removeLayer(tribalDotsLayer); e.target.textContent = 'Show Tribes'; }
    else { map.addLayer(tribalDotsLayer); e.target.textContent = 'Hide Tribes'; }
};
document.getElementById('zoomMN').onclick = () => map.fitBounds([[43.5, -97.5], [49.5, -89.0]]);
document.getElementById('resetMap').onclick = () => map.setView([39.8, -98.5], 4);
document.getElementById('storyToggle').onclick = () => document.getElementById('storyPanel').classList.toggle('visible');
</script>
</body>
</html>
