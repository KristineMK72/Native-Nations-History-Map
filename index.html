<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Echoes of the Land</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: 'Segoe UI', sans-serif;
      background-color: #111;
      color: #f0f0f0;
      overflow: hidden;
    }
    #app-container {
      display: flex;
      height: 100%;
      width: 100%;
    }
    #storyPanel {
      width: 30%;
      background-color: rgba(0,0,0,0.85);
      padding: 20px;
      overflow-y: auto;
      box-shadow: 2px 0 10px rgba(0,0,0,0.5);
      z-index: 1000;
    }
    #map {
      flex: 1;
      height: 100%;
      z-index: 0;
    }
    h2 {
      color: #ffcc66;
      margin-top: 0;
    }
    .chapter {
      margin-bottom: 15px;
    }
    .chapter img {
      max-width: 100%;
      height: auto;
      border: 1px solid #555;
    }
    .controls {
      position: absolute;
      bottom: 15px;
      left: 20px;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 8px;
      z-index: 2000;
    }
    .controls button {
      margin: 3px;
      background: #222;
      color: #fff;
      border: 1px solid #555;
      border-radius: 5px;
      padding: 6px 10px;
      cursor: pointer;
    }
    .controls button:hover {
      background: #444;
    }
    .story-marker div {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #ffcc66;
      box-shadow: 0 0 10px #ffcc66;
    }
    audio {
      width: 100%;
      margin-top: 5px;
    }
    a.pdf-link {
      color: #ffcc66;
      text-decoration: underline;
    }
    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 3000;
      color: #fff;
    }
  </style>
</head>
<body>
  <div id="loading">Loading reservations...</div>
  <div id="app-container">
    <div id="storyPanel">
      <h2>Echoes of the Land</h2>
      <p>Interactive journeys: trails, mounds, reservations, and living cultures</p>
      <p><a href="#" class="pdf-link" onclick="downloadPDF(); return false;">Download Chapter PDF</a> | Narration: On</p>
      <p>Trails available:</p>
      <ul>
        <li>Ojibwe (cyan)</li>
        <li>Potawatomi Trail of Death (red)</li>
        <li>Great Osage (orange)</li>
        <li>Natchez Trace (gold)</li>
      </ul>
      <p>Tip: Click a chapter to fly the map. Toggle reservations/trails from controls.</p>
      <div id="chaptersList"></div>
    </div>
    <div id="map"></div>
  </div>
  <div class="controls">
    <button id="playNext">Play / Next</button>
    <button id="reservationToggle">Show Reservations</button>
    <button id="showAllTrails">Show All Trails</button>
    <button id="potawatomiToggle">Potawatomi</button>
    <button id="greatOsageToggle">Great Osage</button>
    <button id="natchezTraceToggle">Natchez Trace</button>
    <button id="ojibweToggle">Ojibwe</button>
    <button id="hideTribes">Hide Tribes</button>
    <button id="zoomMN">Zoom to MN</button>
    <button id="showStory">Show Story</button>
    <button id="resetMap">Reset</button>
  </div>
  <!-- Ambient Audio (uncomment and place file at audio/powwow_drum.mp3) -->
  <!-- <audio id="ambientAudio" loop autoplay><source src="audio/powwow_drum.mp3" type="audio/mp3"></audio> -->
  <!-- Narrator Audio -->
  <audio id="narrator" preload="auto"></audio>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map, reservationLayer = L.layerGroup(), trailLayers = {}, storyMarkersLayer = L.layerGroup();
    const defaultCenter = [39.8, -98.5], defaultZoom = 4, mnBounds = [[43.5, -97.5], [49.5, -89.0]];
    let currentChapterIndex = 0;

    const storyChapters = [
      { name: "Beringia Crossing", year: "~20,000 BCE", coords: [64.8, -165.0], text: "Ancestors migrated from Siberia via land bridge.", image: "https://via.placeholder.com/150?text=Beringia", audio: "https://upload.wikimedia.org/wikipedia/commons/2/2b/Native_American_Drumming.ogg", pdf: "chapter1.pdf" },
      { name: "White Sands Footprints", year: "~21,000 BCE", coords: [32.95, -106.36], text: "Footprints in New Mexico show early humans.", image: "https://via.placeholder.com/150?text=White+Sands", audio: "https://upload.wikimedia.org/wikipedia/commons/2/2b/Native_American_Drumming.ogg", pdf: "chapter2.pdf" },
      { name: "Clovis Culture", year: "~13,000 BCE", coords: [34.4, -104.1], text: "Paleo-Indian culture with fluted tools.", image: "https://via.placeholder.com/150?text=Clovis", audio: "https://upload.wikimedia.org/wikipedia/commons/2/2b/Native_American_Drumming.ogg", pdf: "chapter3.pdf" },
      { name: "South America Expansion", year: "~15,000 BCE", coords: [-9.5, -75.0], text: "Migrations reached South America.", image: "https://via.placeholder.com/150?text=South+America", audio: "https://upload.wikimedia.org/wikipedia/commons/2/2b/Native_American_Drumming.ogg", pdf: "chapter4.pdf" },
      { name: "Ocmulgee Mounds", year: "~900 CE", coords: [32.83, -83.63], text: "Ceremonial center in Georgia.", image: "https://via.placeholder.com/150?text=Ocmulgee", audio: "https://upload.wikimedia.org/wikipedia/commons/2/2b/Native_American_Drumming.ogg", pdf: "chapter5.pdf" },
      { name: "Serpent Mound", year: "1000 CE", coords: [39.025, -83.43], text: "Ohio effigy mound aligned with solstices.", image: "https://via.placeholder.com/150?text=Serpent+Mound", audio: "https://upload.wikimedia.org/wikipedia/commons/2/2b/Native_American_Drumming.ogg", pdf: "chapter6.pdf" },
      { name: "Cahokia Mounds", year: "1050 CE", coords: [38.65, -90.06], text: "Major city near St. Louis.", image: "https://via.placeholder.com/150?text=Cahokia", audio: "https://upload.wikimedia.org/wikipedia/commons/2/2b/Native_American_Drumming.ogg", pdf: "chapter7.pdf" },
      { name: "Chaco Canyon & Celestial Alignments", year: "1050 CE", coords: [36.06, -107.96], text: "Ancestral Puebloan site with astronomical precision.", image: "https://via.placeholder.com/150?text=Chaco+Canyon", audio: "https://upload.wikimedia.org/wikipedia/commons/2/2b/Native_American_Drumming.ogg", pdf: "chapter8.pdf" },
      { name: "Columbus' Arrival", year: "1492 CE", coords: [24.0667, -74.5], text: "Columbus landed on Guanahani (San Salvador), initiating European colonization.", image: "https://via.placeholder.com/150?text=Columbus", audio: "https://upload.wikimedia.org/wikipedia/commons/2/2b/Native_American_Drumming.ogg", pdf: "chapter9.pdf" },
      { name: "Ojibwe Migration", year: "~1400 CE", coords: [46.5, -93.7], text: "Anishinaabe moved to Minnesota’s wild rice lakes.", image: "https://via.placeholder.com/150?text=Ojibwe", audio: "https://upload.wikimedia.org/wikipedia/commons/2/2b/Native_American_Drumming.ogg", pdf: "chapter10.pdf" },
      { name: "Pueblo Revolt", year: "1680 CE", coords: [35.68, -106.07], text: "Pueblo expelled Spanish colonizers.", image: "https://via.placeholder.com/150?text=Pueblo+Revolt", audio: "https://upload.wikimedia.org/wikipedia/commons/2/2b/Native_American_Drumming.ogg", pdf: "chapter11.pdf" },
      { name: "Trail of Tears", year: "1838–1839 CE", coords: [35.9, -94.9], text: "Forced removal to Oklahoma.", image: "https://via.placeholder.com/150?text=Trail+of+Tears", audio: "https://upload.wikimedia.org/wikipedia/commons/2/2b/Native_American_Drumming.ogg", pdf: "chapter12.pdf" },
      { name: "Wounded Knee", year: "1890 CE", coords: [43.14, -102.36], text: "Massacre of Lakota by U.S. Army.", image: "https://via.placeholder.com/150?text=Wounded+Knee", audio: "https://upload.wikimedia.org/wikipedia/commons/2/2b/Native_American_Drumming.ogg", pdf: "chapter13.pdf" },
      { name: "American Indian Movement", year: "1968 CE", coords: [44.95, -93.10], text: "AIM founded for Indigenous rights.", image: "https://via.placeholder.com/150?text=AIM", audio: "https://upload.wikimedia.org/wikipedia/commons/2/2b/Native_American_Drumming.ogg", pdf: "chapter14.pdf" },
      { name: "Modern Resurgence", year: "Today", coords: [47.5, -94.6], text: "Ojibwe and Dakota revive culture.", image: "https://via.placeholder.com/150?text=Modern+Resurgence", audio: "https://upload.wikimedia.org/wikipedia/commons/2/2b/Native_American_Drumming.ogg", pdf: "chapter15.pdf" }
    ];

    const indigenousTrails = {
      "Potawatomi Trail of Death": { coords: [[41.5, -85.5], [39.5, -86.5], [37.5, -94.0]], color: 'red' },
      "Great Osage": { coords: [[37.0, -95.0], [36.5, -96.0], [35.5, -97.0]], color: 'orange' },
      "Natchez Trace": { coords: [[35.0, -89.0], [34.0, -90.0], [33.0, -91.0]], color: 'gold' },
      "Ojibwe Migration": { coords: [[45.0, -75.7], [46.5, -87.4], [46.2, -91.9], [46.1, -93.6]], color: 'cyan' }
    };

    window.addEventListener('DOMContentLoaded', async () => {
      const mapElement = document.getElementById('map');
      if (!mapElement) {
        console.error("Map container not found!");
        return;
      }
      map = L.map('map', { center: defaultCenter, zoom: defaultZoom, zoomControl: true });
      if (!map) {
        console.error("Failed to initialize Leaflet map");
        return;
      }

      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap & CARTO',
        subdomains: 'abcd',
        maxZoom: 19
      }).addTo(map);

      // Populate trails immediately
      populateTrails();
      Object.values(trailLayers).forEach(layer => map.addLayer(layer)); // Add all trails by default

      // Load reservations asynchronously
      await loadReservations();

      // Populate story markers and panel after layers are ready
      populateStoryMarkers();
      populateStoryPanel();
      updateMapView(storyChapters[0]);
    });

    async function loadReservations() {
      try {
        const response = await fetch('https://gis-calema.opendata.arcgis.com/datasets/23348a6fb3e44322a0c0a862aba62a24_0.geojson?outSR={"latestWkid":3857,"wkid":102100}');
        if (!response.ok) throw new Error('Failed to fetch reservations data');
        const geojson = await response.json();
        console.log(`Loaded ${geojson.features.length} reservations`);
        L.geoJSON(geojson, {
          style: { color: '#800080', fillColor: '#800080', fillOpacity: 0.3, weight: 2 },
          onEachFeature: (feature, layer) => {
            const name = feature.properties.NAME || 'Unnamed Reservation';
            layer.bindPopup(name);
          }
        }).addTo(reservationLayer);
        map.addLayer(reservationLayer); // Ensure reservation layer is added
        document.getElementById('loading').style.display = 'none';
      } catch (error) {
        console.error('Error loading reservations:', error);
        document.getElementById('loading').textContent = 'Failed to load reservations. Showing sample data.';
        const sampleGeoJSON = {
          "type": "FeatureCollection",
          "features": [
            { "type": "Feature", "properties": { "name": "Red Lake Nation" }, "geometry": { "type": "Polygon", "coordinates": [[[-95.3,48.2],[-95.3,47.8],[-94.8,47.8],[-94.8,48.2],[-95.3,48.2]]] } },
            { "type": "Feature", "properties": { "name": "Bois Forte Reservation" }, "geometry": { "type": "Polygon", "coordinates": [[[-93.0,48.2],[-93.0,47.9],[-92.6,47.9],[-92.6,48.2],[-93.0,48.2]]] } },
            { "type": "Feature", "properties": { "name": "Leech Lake Reservation" }, "geometry": { "type": "Polygon", "coordinates": [[[-94.6,47.4],[-94.6,47.1],[-94.2,47.1],[-94.2,47.4],[-94.6,47.4]]] } }
          ]
        };
        L.geoJSON(sampleGeoJSON, {
          style: { color: '#800080', fillColor: '#800080', fillOpacity: 0.3, weight: 2 },
          onEachFeature: (f, l) => l.bindPopup(f.properties.name)
        }).addTo(reservationLayer);
        map.addLayer(reservationLayer); // Add fallback reservations
        document.getElementById('loading').style.display = 'none';
      }
    }

    function populateTrails() {
      Object.entries(indigenousTrails).forEach(([trailName, { coords, color }]) => {
        trailLayers[trailName] = L.polyline(coords, { color, weight: 4, dashArray: '8,4' }).bindPopup(trailName);
      });
    }

    function populateStoryMarkers() {
      storyChapters.forEach(chapter => {
        L.marker(chapter.coords, { icon: L.divIcon({ className: 'story-marker', html: '<div></div>' }) })
          .bindPopup(`<strong>${chapter.name}</strong><br>${chapter.text}`)
          .addTo(storyMarkersLayer);
      });
      map.addLayer(storyMarkersLayer); // Ensure story markers are added
    }

    function populateStoryPanel() {
      const chaptersList = document.getElementById('chaptersList');
      storyChapters.forEach((chapter, index) => {
        const div = document.createElement('div');
        div.className = 'chapter';
        div.innerHTML = `
          <h3>${chapter.name} (${chapter.year})</h3>
          <img src="${chapter.image}" alt="${chapter.name}">
          <p>${chapter.text}</p>
          <audio controls><source src="${chapter.audio}" type="audio/ogg"></audio>
          <button onclick="updateMapView(storyChapters[${index}]); downloadPDF('${chapter.pdf}')">View & Download</button>
        `;
        chaptersList.appendChild(div);
      });
    }

    function updateMapView(chapter) {
      map.flyTo(chapter.coords, 6, { duration: 2 });
      const narrator = document.getElementById('narrator');
      narrator.src = chapter.audio;
      narrator.play().catch(error => console.warn("Narration failed:", error));
    }

    function downloadPDF(pdfFile) {
      console.log(`Downloading ${pdfFile}`);
    }

    document.getElementById('playNext')?.addEventListener('click', () => {
      currentChapterIndex = (currentChapterIndex + 1) % storyChapters.length;
      updateMapView(storyChapters[currentChapterIndex]);
      downloadPDF(storyChapters[currentChapterIndex].pdf);
    });

    document.getElementById('reservationToggle')?.addEventListener('click', e => {
      if (map.hasLayer(reservationLayer)) {
        map.removeLayer(reservationLayer);
        e.target.textContent = 'Show Reservations';
      } else {
        map.addLayer(reservationLayer);
        e.target.textContent = 'Hide Reservations';
      }
    });

    document.getElementById('showAllTrails')?.addEventListener('click', () => {
      Object.values(trailLayers).forEach(layer => map.addLayer(layer));
    });

    document.getElementById('potawatomiToggle')?.addEventListener('click', () => toggleTrail('Potawatomi Trail of Death'));
    document.getElementById('greatOsageToggle')?.addEventListener('click', () => toggleTrail('Great Osage'));
    document.getElementById('natchezTraceToggle')?.addEventListener('click', () => toggleTrail('Natchez Trace'));
    document.getElementById('ojibweToggle')?.addEventListener('click', () => toggleTrail('Ojibwe Migration'));

    document.getElementById('hideTribes')?.addEventListener('click', () => {
      Object.values(trailLayers).forEach(layer => map.removeLayer(layer));
    });

    document.getElementById('zoomMN')?.addEventListener('click', () => map.fitBounds(mnBounds));

    document.getElementById('showStory')?.addEventListener('click', () => {
      document.getElementById('storyPanel').style.display = 'block';
    });

    document.getElementById('resetMap')?.addEventListener('click', () => {
      map.setView(defaultCenter, defaultZoom);
      currentChapterIndex = 0;
      updateMapView(storyChapters[0]);
      Object.values(trailLayers).forEach(layer => map.removeLayer(layer));
      map.addLayer(reservationLayer);
    });

    function toggleTrail(trailName) {
      if (map.hasLayer(trailLayers[trailName])) {
        map.removeLayer(trailLayers[trailName]);
      } else {
        map.addLayer(trailLayers[trailName]);
      }
    }
  </script>
</body>
</html>
