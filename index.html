<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ðŸŒ¿ Echoes of the Land â€” Story Map (Trails + Reservations)</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{ --panel-w: 380px; --bg:#081021; --panel-bg:rgba(14,18,28,0.96); --accent:#8a2be2; --muted:#9fb0cc; }
  html,body{height:100%; margin:0; font-family:Inter, "Segoe UI", system-ui, -apple-system, Arial; background:var(--bg); color:#e8f0ff;}
  .container{display:flex; height:100vh; width:100vw; overflow:hidden;}
  #panel{width:var(--panel-w); min-width:260px; background:var(--panel-bg); padding:16px; box-sizing:border-box; overflow:auto; border-right:1px solid rgba(255,255,255,0.03);}
  #map{flex:1; height:100%; position:relative;}
  header.app-header{display:flex; gap:10px; align-items:center; margin-bottom:12px;}
  header h1{margin:0;font-size:18px;color:var(--accent);} header p{margin:0;font-size:12px;color:var(--muted);}
  .chapter{margin-bottom:12px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02);}
  .chapter h3{margin:0 0 6px 0;font-size:15px;}
  .chapter .year{color:var(--muted); margin-bottom:8px;}
  .btn{background:#0f1724;color:#e7f1ff;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;}
  .controls{display:flex; gap:8px; justify-content:center; padding:10px; position:absolute; bottom:12px; left:var(--panel-w); right:12px; z-index:6500; background:rgba(0,0,0,0.35); border-radius:8px;}
  .map-title{position:absolute; left:var(--panel-w); top:8px; right:12px; text-align:center; z-index:5000; pointer-events:none; color:#fff; font-weight:700; text-shadow:0 1px 2px rgba(0,0,0,0.6);}
  .story-marker div{width:20px;height:20px;border-radius:50%;background:var(--accent);border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.6);}
  .trail-legend{margin-top:8px;font-size:13px;color:var(--muted);}
  @media(max-width:900px){
    #panel{position:absolute; left:0; top:0; bottom:0; transform:translateX(-100%); transition:transform .28s ease; z-index:8000; width:85%;}
    #panel.visible{transform:translateX(0);}
    .map-title{left:12px;right:12px;}
    .controls{left:12px;right:12px;}
  }
</style>
</head>
<body>
  <div class="container">
    <aside id="panel" aria-label="Story panel">
      <header class="app-header">
        <div>
          <h1>ðŸŒ¿ Echoes of the Land</h1>
          <p>Interactive journeys: trails, mounds, reservations, and living cultures</p>
        </div>
      </header>

      <div id="chapters"></div>

      <div style="display:flex;gap:8px;margin-top:8px;">
        <button id="downloadPDF" class="btn">Download Chapter PDF</button>
        <button id="toggleNarration" class="btn">Narration: Off</button>
      </div>

      <div class="trail-legend">
        <strong>Trails available:</strong>
        <div>â€¢ Ojibwe (cyan) â€¢ Potawatomi Trail of Death (red) â€¢ Great Osage (orange) â€¢ Natchez Trace (gold)</div>
      </div>

      <div style="margin-top:12px;color:var(--muted);font-size:12px;">
        Tip: Click a chapter to fly the map. Toggle reservations/trails from controls. To add ambient audio, save file at <code>audio/powwow_drum.mp3</code> and uncomment the &lt;audio&gt; tag in the HTML.
      </div>
    </aside>

    <main id="map">
      <div class="map-title" id="mapTitle">Earliest North American Migrations</div>
    </main>
  </div>

  <div class="controls" id="controls">
    <button id="playNext" class="btn">Play / Next</button>
    <button id="reservationToggle" class="btn">Show Reservations</button>
    <button id="trailToggleAll" class="btn">Show All Trails</button>
    <button id="potawatomiToggle" class="btn">Potawatomi</button>
    <button id="osageToggle" class="btn">Great Osage</button>
    <button id="natchezToggle" class="btn">Natchez Trace</button>
    <button id="ojibweToggle" class="btn">Ojibwe</button>
    <button id="tribalToggle" class="btn">Hide Tribes</button>
    <button id="zoomMN" class="btn">Zoom to MN</button>
    <button id="panelToggle" class="btn">Show Story</button>
    <button id="resetMap" class="btn">Reset</button>
  </div>

  <!-- Optional: add powwow audio into /audio/powwow_drum.mp3 and uncomment -->
  <!--
  <audio id="powWowAudio" loop preload="auto">
    <source src="audio/powwow_drum.mp3" type="audio/mpeg">
  </audio>
  -->

<script>
/* =========================
   Data & config
   ========================= */

const storyChapters = [
  { id:'beringia', name: "Beringia Crossing", year: "~20,000 BCE", coords: [64.8, -165.0], text: "Ancestors crossed Beringia from Asia into Alaska; earliest migrations inland.", mapTitle:"Earliest North American Migrations" },
  { id:'white-sands', name: "White Sands Footprints", year: "~21,000 BCE", coords: [32.7836, -106.1516], text: "White Sands, NM: ancient human footprints preserved in gypsum dunes.", mapTitle:"White Sands: Ancient Footprints" },
  { id:'chaco', name: "Chaco Canyon (Sirius)", year: "~1050 CE", coords: [36.0609, -107.9619], text: "Chaco Canyon's ceremonial center aligns to stars including Sirius.", mapTitle:"Chaco Canyon & Celestial Alignments" },
  { id:'serpent', name: "Serpent Mound", year: "~1070 CE", coords: [39.0253, -83.4306], text: "Serpent Mound in Ohio aligns with solstice events; impressive earthwork.", mapTitle:"Serpent Mound & Solstice" },
  { id:'jackson', name: "Jackson Mound Group", year: "~500-1300 CE", coords: [39.3, -82.98], text: "Jackson Mound Group and Adena/Hopewell ceremonial network in Ohio.", mapTitle:"Jackson Mound Group" },
  { id:'ocmulgee', name: "Ocmulgee Mounds", year: "~900 CE", coords: [32.8379, -83.6494], text: "Ocmulgee preserves Mississippian & earlier earthworks in Georgia.", mapTitle:"Ocmulgee Mounds" },
  { id:'mississippian', name: "Cahokia (Mississippian)", year: "~1000 CE", coords: [38.6572, -90.0530], text: "Cahokia: complex Mississippian urban center with massive mounds.", mapTitle:"Cahokia & Mississippian Culture" },
  { id:'glacial', name: "Great Glacier Melt / Impact", year: "~12,000 BCE", coords: [47.5, -96.0], text: "Large-scale melt events and proposed impact hypotheses reshaped landscapes and spawned flood memories.", mapTitle:"Glacial Melt & Great Flood" },
  { id:'ojibwe', name: "Ojibwe Migration & Anishinaabe", year: "~1400 CE", coords: [46.75, -85.5], text: "Anishinaabe (Ojibwe) migration along the Great Lakes; language & cultural revitalization today.", mapTitle:"Anishinaabe Migration & Language" },
  { id:'trail-of-tears', name: "Removal Era / Trail of Tears", year: "1830s CE", coords: [35.5, -85.0], text: "Indian Removal and the Trail of Tears displaced many tribal nations.", mapTitle:"Trail of Tears (Removal Era)" },
  { id:'military', name: "US Military Geo Trails", year: "1800s", coords: [39.5, -98.5], text: "Military surveys and early transport corridors traversed Indigenous lands.", mapTitle:"Military Surveys & Geo Trails" }
];

/* Fallback reservation polygon (small sample) */
const fallbackReservations = {
  "type":"FeatureCollection","features":[
    {"type":"Feature","properties":{"name":"Bois Forte Reservation","tribe":"Bois Forte Band of Chippewa"},"geometry":{"type":"Polygon","coordinates":[[[-93.028,48.047],[-92.945,47.986],[-92.875,47.92],[-92.721,47.95],[-92.721,48.071],[-92.845,48.09],[-93.028,48.047]]]}}
  ]
};

/* Fallback trail if NPS fetch fails */
const fallbackTrail = {
  "type":"FeatureCollection","features":[{"type":"Feature","properties":{"name":"fallback trail"},"geometry":{"type":"LineString","coordinates":[[-83.3370,35.5019],[-84.9926,34.9654],[-88.0863,34.9392],[-94.3986,35.3853],[-94.9754,35.9189]]}}]
};

/* Ojibwe trail (restored) */
const ojibweTrail = {
  id:'ojibwe',
  name:'Ojibwe Migration Route',
  color:'#00BFFF',
  weight:3,
  coords:[[45.0,-84.0],[46.0,-86.0],[46.7,-85.5],[46.75,-92.1],[46.7,-93.6]],
  stops:[
    {name:'Eastward Origin', coords:[45.0,-84.0], popup:'Traditional lands'},
    {name:'Sault Ste. Marie', coords:[46.5050,-84.3540], popup:'Gichigamiin (gathering)'},
    {name:'Madeline Island', coords:[46.8118,-90.7937], popup:'Spirit Island'},
    {name:'Duluth/Superior', coords:[46.75,-92.1], popup:'Lake Superior port'}
  ]
};

/* Potawatomi Trail of Death (sample stops) */
const potawatomiTrail = {
  id:'potawatomi',
  name:'Potawatomi Trail of Death (1838)',
  color:'#c72b2b',
  weight:3,
  coords:[[41.54,-86.30],[40.76,-86.15],[39.77,-86.13],[38.98,-87.54],[38.25,-88.97],[37.95,-89.07],[38.48,-94.81]], // rough path
  stops:[
    {name:'Twin Lakes, IN', coords:[41.1847,-86.2404], popup:'Start (Nov 1838)'},
    {name:'Kokomo area', coords:[40.4864,-86.1336], popup:'Camp stop'},
    {name:'Terre Haute', coords:[39.4667,-87.4139], popup:'Camp stop'},
    {name:'Mount Vernon, IL', coords:[37.8299,-88.902], popup:'Camp stop'},
    {name:'Osawatomie, KS', coords:[38.4845,-94.8109], popup:'Destination region'}
  ]
};

/* Great Osage Trail (sample) */
const osageTrail = {
  id:'osage',
  name:'Great Osage Trail',
  color:'#ff8c00',
  weight:3,
  coords:[[39.1,-94.5],[38.5,-95.5],[37.5,-97.0],[36.5,-98.5]],
  stops:[
    {name:'Independence, MO area', coords:[39.0911,-94.4155], popup:'Osage/Independence crossing'},
    {name:'Council Grove, KS', coords:[38.6625,-96.4817], popup:'Historic crossing'},
    {name:'Emporia, KS area', coords:[38.4039,-96.1817], popup:'Trail waypoint'}
  ]
};

/* Natchez Trace (indigenous origin) sample */
const natchezTrace = {
  id:'natchez',
  name:'Natchez Trace (Indigenous Path)',
  color:'#d4af37',
  weight:3,
  coords:[[35.0,-90.0],[33.4,-88.4],[31.56,-90.46]],
  stops:[
    {name:'Nashville approach', coords:[36.1627,-86.7816], popup:'Ancestor paths'},
    {name:'Natchez, MS', coords:[31.5604,-91.4032], popup:'Southern terminus'}
  ]
};

/* other small data */
const tribalPoints = [
  {name:"Navajo Nation", tribe:"DinÃ©", coords:[35.8427,-109.5218], pop:173000},
  {name:"Cherokee Nation HQ", tribe:"Cherokee", coords:[36.1983,-94.9822], pop:140000},
];

/* Official endpoints to try (live fetch) */
const TIGER_RESERVATIONS_GEOJSON = 'https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/Tribal/MapServer/0/query?where=1%3D1&outFields=*&f=geojson';
const NPS_TRAIL_OPENDATA_GEOJSON = 'https://opendata.arcgis.com/datasets/nps::trte-nht-congressionally-designated-alignment.geojson';

/* =========================
   Map initialization & layers
   ========================= */
let map;
let chapterMarkers = L.layerGroup();
let reservationLayer = L.layerGroup();
let trailLayer = L.layerGroup();
let tribalLayer = L.layerGroup();
let otherTrails = {}; // store by id for toggling
let currentChapterIndex = 0;
let narrationOn = false;

window.addEventListener('DOMContentLoaded', async () => {
  map = L.map('map', { center:[39.8,-98.5], zoom:4, minZoom:2 });
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap & CARTO' }).addTo(map);

  // populate primary layers
  populateChapters();
  populateTribalPoints();

  // add story markers
  populateStoryMarkers();

  // try official data fetches (with fallbacks)
  await tryLoadReservations();
  await tryLoadNpsTrail();

  // add all extra trails (Ojibwe + 3 more)
  registerTrail(ojibweTrail);
  registerTrail(potawatomiTrail);
  registerTrail(osageTrail);
  registerTrail(natchezTrace);

  // add glacial/military placeholder layers
  addGlacialLayer();
  addMilitaryLayer();

  // show first chapter
  renderChaptersUI();
  updateToChapter(0);

  // minor forced redraw
  setTimeout(()=> map.invalidateSize(), 250);
});

/* -------------------------
   Chapters UI + markers
   ------------------------- */
function populateStoryMarkers(){
  chapterMarkers.clearLayers();
  const icon = L.divIcon({ className:'story-marker', iconSize:[22,22], html:'<div></div>' });
  storyChapters.forEach((ch, idx) => {
    const m = L.marker(ch.coords, { icon }).bindPopup(`<b>${ch.name}</b><br>${ch.text}`);
    m.chapterIndex = idx;
    m.on('click', ()=> updateToChapter(idx));
    chapterMarkers.addLayer(m);
  });
  chapterMarkers.addTo(map);
}

function renderChaptersUI(){
  const container = document.getElementById('chapters');
  container.innerHTML = '';
  storyChapters.forEach((ch, idx) => {
    const el = document.createElement('div');
    el.className = 'chapter';
    el.innerHTML = `<h3>${ch.name}</h3><div class="year">${ch.year}</div><p>${ch.text}</p>`;
    el.addEventListener('click', ()=> updateToChapter(idx));
    container.appendChild(el);
  });
}

/* -------------------------
   Chapter update
   ------------------------- */
function updateToChapter(idx){
  currentChapterIndex = idx;
  const ch = storyChapters[idx];
  document.getElementById('mapTitle').textContent = ch.mapTitle || ch.name;
  map.flyTo(ch.coords, 6, { duration:1.4 });
  // open matching popup
  chapterMarkers.eachLayer(l => { if(l.chapterIndex === idx) l.openPopup(); else l.closePopup(); });
  // highlight UI
  const elems = document.querySelectorAll('#chapters .chapter');
  elems.forEach((el,i)=> el.style.opacity = (i===idx ? '1':'0.6'));
  if(narrationOn) speakChapter(ch);
}

/* -------------------------
   Tribal points
   ------------------------- */
function populateTribalPoints(){
  tribalLayer.clearLayers();
  tribalPoints.forEach(p=>{
    L.circleMarker(p.coords, { radius:4, color:'#33ff33', fillColor:'#33ff33', fillOpacity:0.8 }).bindPopup(`<b>${p.name}</b><br>${p.tribe}`).addTo(tribalLayer);
  });
  tribalLayer.addTo(map);
}

/* -------------------------
   Trail registration/toggling
   ------------------------- */
function registerTrail(trailObj){
  // keep entry
  otherTrails[trailObj.id] = { obj: trailObj, group: L.layerGroup() };
  const group = otherTrails[trailObj.id].group;
  // polyline
  if(trailObj.coords){
    const latlngs = trailObj.coords.map(c=>[c[0], c[1]]);
    L.polyline(latlngs, { color:trailObj.color, weight:trailObj.weight, dashArray:'6,6' }).bindPopup(trailObj.name).addTo(group);
  }
  // stops
  if(Array.isArray(trailObj.stops)){
    trailObj.stops.forEach(s=>{
      L.circleMarker(s.coords, { radius:5, color:trailObj.color, fillColor:trailObj.color, fillOpacity:0.95 }).bindPopup(`<strong>${s.name}</strong><br>${s.popup||''}`).addTo(group);
    });
  }
  // do not add to map by default (user toggles)
}

/* -------------------------
   Official fetch: Reservations (TIGER)
   ------------------------- */
async function tryLoadReservations(){
  try {
    console.info('Fetching TIGER reservations...');
    const resp = await fetch(TIGER_RESERVATIONS_GEOJSON);
    if(!resp.ok) throw new Error('HTTP ' + resp.status);
    const geo = await resp.json();
    if(geo && geo.type === 'FeatureCollection'){
      L.geoJSON(geo, { style:{ color:'#800080', weight:1.6, fillOpacity:0.18 }, onEachFeature:(f,l)=>{ const p=f.properties||{}; l.bindPopup(`<strong>${p.NAME||p.name||'Reservation'}</strong><br>${p.TRIBALNAME||p.tribe||''}`); } }).addTo(reservationLayer);
      console.info('TIGER reservations added.');
      return;
    }
    throw new Error('Invalid geojson');
  } catch(err){
    console.warn('TIGER fetch failed, using fallback reservations.', err);
    L.geoJSON(fallbackReservations, { style:{ color:'#800080', weight:1.6, fillOpacity:0.18 }, onEachFeature:(f,l)=> l.bindPopup(`<strong>${f.properties.name}</strong>`) }).addTo(reservationLayer);
  }
}

/* -------------------------
   Try load NPS Trail (ArcGIS/OpenData)
   ------------------------- */
async function tryLoadNpsTrail(){
  try {
    console.info('Fetching NPS Trail of Tears GeoJSON...');
    const resp = await fetch(NPS_TRAIL_OPENDATA_GEOJSON);
    if(!resp.ok) throw new Error('HTTP ' + resp.status);
    const geo = await resp.json();
    if(geo && geo.type === 'FeatureCollection'){
      L.geoJSON(geo, { style:{ color:'#8B0000', weight:3, dashArray:'10,6' } }).addTo(trailLayer);
      console.info('NPS Trail added to trailLayer.');
      return;
    }
    throw new Error('Invalid geojson');
  } catch(err){
    console.warn('Failed to fetch NPS trail; adding fallback polyline.', err);
    const cords = fallbackTrail.features[0].geometry.coordinates.map(c=>[c[1],c[0]]);
    L.polyline(cords, { color:'#8B0000', weight:3, dashArray:'10,6' }).addTo(trailLayer);
  }
}

/* -------------------------
   Glacial and military placeholders
   ------------------------- */
function addGlacialLayer(){
  const circ = L.circle([47.5,-96.0], { radius:700000, color:'#FFA500', fillOpacity:0.06, weight:1 }).bindPopup('Glacial melt / impact hypothesis area');
  glacialLayer = L.layerGroup(); glacialLayer.addLayer(circ);
}
function addMilitaryLayer(){
  militaryLayer = L.layerGroup();
  L.polyline([[39,-96],[40,-100],[41,-105]], { color:'#ff4444', weight:2, dashArray:'4,6' }).bindPopup('Historic military survey trails (placeholder)').addTo(militaryLayer);
}

/* -------------------------
   Controls wiring
   ------------------------- */
document.getElementById('playNext').addEventListener('click', ()=>{
  const next = (currentChapterIndex + 1) % storyChapters.length;
  updateToChapter(next);
});
document.getElementById('panelToggle').addEventListener('click', ()=>{
  const p = document.getElementById('panel'); p.classList.toggle('visible'); document.getElementById('panelToggle').textContent = p.classList.contains('visible') ? 'Hide Story' : 'Show Story';
});
document.getElementById('reservationToggle').addEventListener('click', (e)=>{
  if(map.hasLayer(reservationLayer)){ map.removeLayer(reservationLayer); e.target.textContent='Show Reservations'; }
  else { map.addLayer(reservationLayer); e.target.textContent='Hide Reservations'; }
});
document.getElementById('trailToggleAll').addEventListener('click', (e)=>{
  const anyShown = Object.values(otherTrails).some(t=> map.hasLayer(t.group));
  if(anyShown){
    Object.values(otherTrails).forEach(t=> map.removeLayer(t.group));
    map.removeLayer(trailLayer);
    e.target.textContent = 'Show All Trails';
  } else {
    Object.values(otherTrails).forEach(t=> map.addLayer(t.group));
    map.addLayer(trailLayer);
    e.target.textContent = 'Hide All Trails';
  }
});
document.getElementById('potawatomiToggle').addEventListener('click', ()=> toggleTrail('potawatomi'));
document.getElementById('osageToggle').addEventListener('click', ()=> toggleTrail('osage'));
document.getElementById('natchezToggle').addEventListener('click', ()=> toggleTrail('natchez'));
document.getElementById('ojibweToggle').addEventListener('click', ()=> toggleTrail('ojibwe'));
function toggleTrail(id){
  const t = otherTrails[id];
  if(!t) return;
  if(map.hasLayer(t.group)){ map.removeLayer(t.group); document.getElementById(id+'Toggle')?.setAttribute('aria-pressed','false'); }
  else{ map.addLayer(t.group); document.getElementById(id+'Toggle')?.setAttribute('aria-pressed','true'); }
}

document.getElementById('tribalToggle').addEventListener('click', (e)=>{
  if(map.hasLayer(tribalLayer)){ map.removeLayer(tribalLayer); e.target.textContent='Show Tribes'; }
  else{ map.addLayer(tribalLayer); e.target.textContent='Hide Tribes'; }
});
document.getElementById('zoomMN').addEventListener('click', ()=> map.fitBounds([[43.5,-97.5],[49.5,-89.0]]));
document.getElementById('resetMap').addEventListener('click', ()=> { map.setView([39.8,-98.5],4); updateToChapter(0); });

/* -------------------------
   Narration & PDF download
   ------------------------- */
let synth = window.speechSynthesis;
document.getElementById('toggleNarration').addEventListener('click', ()=>{
  narrationOn = !narrationOn;
  document.getElementById('toggleNarration').textContent = narrationOn ? 'Narration: On' : 'Narration: Off';
  if(narrationOn) speakChapter(storyChapters[currentChapterIndex]);
});
function speakChapter(ch){ if(!narrationOn || !('speechSynthesis' in window)) return; synth.cancel(); const text = `${ch.name}. ${ch.year}. ${stripHTML(ch.text)}`; const u = new SpeechSynthesisUtterance(text); u.lang='en-US'; u.rate=1.0; synth.speak(u); }
function stripHTML(s){ const d=document.createElement('div'); d.innerHTML=s; return d.textContent||d.innerText||''; }

document.getElementById('downloadPDF').addEventListener('click', ()=>{
  const { jsPDF } = window.jspdf;
  const ch = storyChapters[currentChapterIndex];
  const doc = new jsPDF({ unit:'pt', format:'letter' });
  const margin=40; doc.setFontSize(18); doc.text(ch.name, margin, 60); doc.setFontSize(12); doc.text(`Era/Year: ${ch.year}`, margin, 86);
  const lines = doc.splitTextToSize(stripHTML(ch.text), 520);
  doc.text(lines, margin, 110); doc.save(`${ch.name.replace(/\s+/g,'_')}_summary.pdf`);
});

/* -------------------------
   Speech safety: stop on unload
   ------------------------- */
window.addEventListener('beforeunload', ()=> { if(synth) synth.cancel(); });

/* End */
</script>
</body>
</html>
