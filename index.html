<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Echoes of the Land: Indigenous Story Map</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100%; width: 100%;
      font-family: 'Segoe UI', sans-serif;
      background-color: #111;
      color: #f0f0f0;
      overflow: hidden;
    }
    #app-container {
      display: flex;
      height: 100%;
      width: 100%;
    }
    #storyPanel {
      width: 30%;
      background-color: rgba(0,0,0,0.85);
      padding: 20px;
      overflow-y: auto;
      box-shadow: 2px 0 10px rgba(0,0,0,0.5);
      z-index: 1000;
    }
    #map {
      flex: 1;
      height: 100%;
      z-index: 0;
    }
    h2 { color: #ffcc66; margin-top: 0; }
    .controls {
      position: absolute;
      bottom: 15px; left: 20px;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 8px;
      z-index: 2000;
    }
    .controls button {
      margin: 3px;
      background: #222;
      color: #fff;
      border: 1px solid #555;
      border-radius: 5px;
      padding: 6px 10px;
      cursor: pointer;
    }
    .controls button:hover {
      background: #444;
    }
    .story-marker div {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #ffcc66;
      box-shadow: 0 0 10px #ffcc66;
    }
  </style>
</head>
<body>
<div id="app-container">
  <div id="storyPanel">
    <h2 id="storyEra">Ancient Migrations</h2>
    <p id="storyYear">~20,000 BCE</p>
    <p id="storyText">Beringia Crossing: Ancestors migrate from Siberia via land bridge.</p>
  </div>
  <div id="map"></div>
</div>

<div class="controls">
  <button id="playPause">Next Chapter ▶</button>
  <button id="reservationToggle">Show Reservations</button>
  <button id="trailToggle">Show Trails</button>
  <button id="zoomMN">Zoom to MN</button>
  <button id="resetMap">Reset Map</button>
</div>

<!-- Powwow Drum Audio (you can replace URL later) -->
<audio id="drumAudio" preload="auto">
  <source src="https://upload.wikimedia.org/wikipedia/commons/2/2b/Native_American_Drumming.ogg" type="audio/ogg">
</audio>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
let map, reservationLayer = L.layerGroup(), trailLayer = L.layerGroup(), storyMarkersLayer = L.layerGroup();
const defaultCenter = [39.8, -98.5], defaultZoom = 4, mnBounds = [[43.5, -97.5], [49.5, -89.0]];
let currentChapterIndex = 0;

// --- STORY CHAPTERS ---
const storyChapters = [
  { name: "Beringia Crossing", year: "~20,000 BCE", coords: [64.8, -165.0], text: "Ancestors migrate via the Bering land bridge from Siberia into Alaska." },
  { name: "Ocmulgee Mounds", year: "~900 CE", coords: [32.83, -83.63], text: "Ceremonial center of Mississippian culture in present-day Georgia." },
  { name: "Serpent Mound", year: "1000 CE", coords: [39.025, -83.43], text: "The Great Serpent Mound aligns with solstice and may represent a comet or cosmic event." },
  { name: "Ojibwe Migration", year: "~1400 CE", coords: [46.5, -93.7], text: "Anishinaabe people move west following the sacred prophecy toward 'the place where food grows on water'—wild rice lakes of Minnesota." },
  { name: "Trail of Tears", year: "1838–1839 CE", coords: [35.9, -94.9], text: "Forced removal of Cherokee, Creek, and other Nations to Indian Territory." },
  { name: "Modern Resurgence", year: "Today", coords: [47.5, -94.6], text: "Ojibwe and Dakota communities maintain cultural and language revival across Minnesota." }
];

// --- RESERVATION POLYGONS (sample) ---
const mnReservationsGeoJSON = {
  "type": "FeatureCollection",
  "features": [
    { "type": "Feature", "properties": { "name": "Red Lake Nation" }, "geometry": { "type": "Polygon", "coordinates": [[[-95.3,48.2],[-95.3,47.8],[-94.8,47.8],[-94.8,48.2],[-95.3,48.2]]] } },
    { "type": "Feature", "properties": { "name": "Bois Forte Reservation" }, "geometry": { "type": "Polygon", "coordinates": [[[-93.0,48.2],[-93.0,47.9],[-92.6,47.9],[-92.6,48.2],[-93.0,48.2]]] } },
    { "type": "Feature", "properties": { "name": "Leech Lake Reservation" }, "geometry": { "type": "Polygon", "coordinates": [[[-94.6,47.4],[-94.6,47.1],[-94.2,47.1],[-94.2,47.4],[-94.6,47.4]]] } }
  ]
};

// --- TRAILS ---
const indigenousTrails = {
  "Trail of Tears": [
    [35.5019, -83.3370], [34.9654, -84.9926], [34.9392, -88.0863], [35.3853, -94.3986], [35.9189, -94.9754]
  ],
  "Ojibwe Migration": [
    [45.0, -75.7], [46.5, -87.4], [46.2, -91.9], [46.1, -93.6]
  ]
};

// --- INITIALIZE MAP ---
window.addEventListener('DOMContentLoaded', () => {
  map = L.map('map', { center: defaultCenter, zoom: defaultZoom, zoomControl: true });
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap & CARTO', subdomains: 'abcd', maxZoom: 19
  }).addTo(map);
  
  populateLayers();
  updateStoryPanel(storyChapters[0]);
});

// --- FUNCTIONS ---
function populateLayers() {
  // Story markers
  storyChapters.forEach(chapter => {
    const marker = L.marker(chapter.coords, { icon: L.divIcon({ className: 'story-marker', html: '<div></div>' }) })
      .bindPopup(`<strong>${chapter.name}</strong><br>${chapter.text}`);
    storyMarkersLayer.addLayer(marker);
  });
  storyMarkersLayer.addTo(map);

  // Reservations
  L.geoJSON(mnReservationsGeoJSON, {
    style: { color: '#800080', fillColor: '#800080', fillOpacity: 0.3, weight: 2 },
    onEachFeature: (f, l) => l.bindPopup(f.properties.name)
  }).addTo(reservationLayer);

  // Trails
  Object.entries(indigenousTrails).forEach(([trailName, coords]) => {
    L.polyline(coords, { color: '#cc4444', weight: 4, dashArray: '8,4' }).bindPopup(trailName).addTo(trailLayer);
  });
}

function updateStoryPanel(chapter) {
  document.getElementById('storyEra').textContent = chapter.name;
  document.getElementById('storyYear').textContent = chapter.year;
  document.getElementById('storyText').textContent = chapter.text;
  
  // Play drum sound on each chapter change
  const drum = document.getElementById('drumAudio');
  drum.currentTime = 0;
  drum.play().catch(()=>{});
  
  map.flyTo(chapter.coords, 6, { duration: 2 });
}

// --- BUTTON EVENTS ---
document.getElementById('playPause').addEventListener('click', () => {
  currentChapterIndex = (currentChapterIndex + 1) % storyChapters.length;
  updateStoryPanel(storyChapters[currentChapterIndex]);
});

document.getElementById('reservationToggle').addEventListener('click', e => {
  if(map.hasLayer(reservationLayer)){ map.removeLayer(reservationLayer); e.target.textContent='Show Reservations'; }
  else { map.addLayer(reservationLayer); e.target.textContent='Hide Reservations'; }
});

document.getElementById('trailToggle').addEventListener('click', e => {
  if(map.hasLayer(trailLayer)){ map.removeLayer(trailLayer); e.target.textContent='Show Trails'; }
  else { map.addLayer(trailLayer); e.target.textContent='Hide Trails'; }
});

document.getElementById('zoomMN').addEventListener('click',()=>map.fitBounds(mnBounds));
document.getElementById('resetMap').addEventListener('click',()=>{ map.setView(defaultCenter, defaultZoom); currentChapterIndex=0; updateStoryPanel(storyChapters[0]); });

</script>
</body>
</html>
